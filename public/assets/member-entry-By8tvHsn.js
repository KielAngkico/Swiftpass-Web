import{u as B,c as C,r as d,d as P,j as t}from"./index-BYZoeFiF.js";import{S as k}from"./StaffSidebar-CfYjULwa.js";import"./index-D-5OJeWc.js";const u="",q=()=>{var v,w,S,D,I,E,$,A,T,L;const{user:n}=B(),{globalEntryLogs:_}=C(),[p,j]=d.useState([]),[c,f]=d.useState([]),[o,y]=d.useState([]),[g,N]=d.useState(!0),h=d.useRef(new Set),b=d.useCallback(async()=>{var s;if(n!=null&&n.adminId)try{N(!0);const e=await P.get(`/api/staff-entry-logs/${n.adminId}`);console.log("ðŸ“Š Fetched logs from API:",e.data),j(e.data.recentEntryList||[])}catch(e){console.error("âŒ Error fetching logs:",e),((s=e.response)==null?void 0:s.status)===401&&(window.location.href="/login")}finally{N(!1)}},[n==null?void 0:n.adminId]);d.useEffect(()=>{b()},[b]),d.useEffect(()=>{_!=null&&_.length&&_.forEach(s=>{const e=s!=null&&s.data?s.data:s;if(!(e!=null&&e.rfid_tag))return;console.log("ðŸ”„ Processing real-time update:",e);const l=e.entry_time&&!e.exit_time,x=e.exit_time;if(l){const m={id:`entry-${e.rfid_tag}-${Date.now()}`,rfid_tag:e.rfid_tag,full_name:e.full_name||"Unknown",profile_image_url:e.profile_image_url,timestamp:e.timestamp||new Date().toISOString(),visitor_type:e.visitor_type,system_type:e.system_type,deducted_amount:e.deducted_amount};f([m]),y(i=>i.filter(a=>a.rfid_tag!==e.rfid_tag))}else if(x){const m={id:`exit-${e.rfid_tag}-${Date.now()}`,rfid_tag:e.rfid_tag,full_name:e.full_name||"Unknown",profile_image_url:e.profile_image_url,timestamp:e.timestamp||new Date().toISOString(),visitor_type:e.visitor_type,system_type:e.system_type};y([m]),f(i=>i.filter(a=>a.rfid_tag!==e.rfid_tag))}j(m=>{const i=[...m];if(e.id){const a=i.findIndex(r=>r.id===e.id);a!==-1?i[a]={...i[a],...e,entry_time:e.entry_time||i[a].entry_time,exit_time:e.exit_time||i[a].exit_time,status:e.status||i[a].status,member_status:e.status||i[a].member_status,deducted_amount:e.deducted_amount??i[a].deducted_amount,remaining_balance:e.remaining_balance??i[a].remaining_balance,last_activity:e.timestamp||new Date().toISOString()}:i.unshift({id:e.id,rfid_tag:e.rfid_tag,full_name:e.full_name,profile_image_url:e.profile_image_url,entry_time:e.entry_time||null,exit_time:e.exit_time||null,status:e.status||"outside",member_status:e.status||"outside",visitor_type:e.visitor_type,system_type:e.system_type,deducted_amount:e.deducted_amount,remaining_balance:e.remaining_balance,subscription_expiry:e.subscription_expiry,staff_name:e.staff_name,last_activity:e.timestamp||new Date().toISOString()})}else if(l)i.findIndex(r=>r.rfid_tag===e.rfid_tag&&(r.member_status==="inside"||r.status==="inside"))===-1&&i.unshift({id:`temp-${e.rfid_tag}-${Date.now()}`,rfid_tag:e.rfid_tag,full_name:e.full_name,profile_image_url:e.profile_image_url,entry_time:e.entry_time,exit_time:null,status:"inside",member_status:"inside",visitor_type:e.visitor_type,system_type:e.system_type,deducted_amount:e.deducted_amount,remaining_balance:e.remaining_balance,subscription_expiry:e.subscription_expiry,staff_name:e.staff_name,last_activity:e.timestamp||new Date().toISOString()});else if(x){const a=i.findIndex(r=>r.rfid_tag===e.rfid_tag&&(r.member_status==="inside"||r.status==="inside"));a!==-1&&(i[a]={...i[a],exit_time:e.exit_time,status:"outside",member_status:"outside",last_activity:e.timestamp||new Date().toISOString()})}return i.sort((a,r)=>{const R=new Date(a.last_activity||a.entry_time||a.exit_time||0);return new Date(r.last_activity||r.entry_time||r.exit_time||0)-R})})})},[_]),d.useEffect(()=>{const s=setInterval(()=>{const e=Date.now(),l=e-3e4,x=e-36e5;f(i=>i.filter(a=>new Date(a.timestamp).getTime()>l)),y(i=>i.filter(a=>new Date(a.timestamp).getTime()>l));const m=Array.from(h.current);h.current.clear(),m.forEach(i=>{const a=i.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/);a&&new Date(a[0]).getTime()>x&&h.current.add(i)})},1e3);return()=>clearInterval(s)},[]);const O=p.filter(s=>s.member_status==="inside"||s.status==="inside").length,M=p.filter(s=>s.member_status==="outside"||s.status==="outside").length;return g?t.jsxs("div",{className:"flex",children:[t.jsx(k,{}),t.jsxs("div",{className:"flex-1 p-6 text-center py-12",children:[t.jsx("div",{className:"text-4xl mb-4",children:"â³"}),t.jsx("p",{className:"text-gray-600",children:"Loading member status..."})]})]}):t.jsxs("div",{className:"flex",children:[t.jsx(k,{}),t.jsxs("div",{className:"flex-1 p-6 overflow-auto",children:[t.jsxs("div",{className:"mb-6 flex justify-between items-center",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-2xl font-bold",children:"Member Entry/Exit Status"}),n&&t.jsxs("p",{className:"text-sm text-gray-600",children:["Logged in as: ",n.name," (",n.role,")"]})]}),t.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[t.jsxs("button",{onClick:b,disabled:g,className:"px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 disabled:opacity-50",children:[g?"ðŸ”„":"â†»"," Refresh"]}),t.jsxs("div",{className:"text-green-600 font-semibold",children:["ðŸŸ¢ Inside: ",O]}),t.jsxs("div",{className:"text-red-600 font-semibold",children:["ðŸ”´ Outside: ",M]}),t.jsxs("div",{className:"text-gray-600",children:["Total: ",p.length]})]})]}),t.jsxs("div",{className:"flex gap-4 mb-6",children:[t.jsxs("div",{className:"flex-1 bg-green-100 p-4 rounded-lg shadow flex items-center gap-6",children:[t.jsx("img",{src:`${u}/${((v=c[0])==null?void 0:v.profile_image_url)||"uploads/members/default.jpg"}`,alt:((w=c[0])==null?void 0:w.full_name)||"N/A",className:"w-28 h-28 rounded-lg object-cover border-2 border-green-200",onError:s=>{s.currentTarget.src=`${u}/uploads/members/default.jpg`}}),t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"font-medium text-gray-800 text-lg",children:((S=c[0])==null?void 0:S.full_name)||"N/A"}),t.jsxs("p",{className:"text-sm text-gray-500",children:["Time: ",(D=c[0])!=null&&D.timestamp?new Date(c[0].timestamp).toLocaleTimeString():"N/A"]}),t.jsx("span",{className:"text-sm bg-green-200 text-green-800 px-3 py-1 rounded mt-1 inline-block",children:((I=c[0])==null?void 0:I.visitor_type)||"N/A"})]})]}),t.jsxs("div",{className:"flex-1 bg-red-100 p-4 rounded-lg shadow flex items-center gap-6",children:[t.jsx("img",{src:`${u}/${((E=o[0])==null?void 0:E.profile_image_url)||"uploads/members/default.jpg"}`,alt:(($=o[0])==null?void 0:$.full_name)||"N/A",className:"w-28 h-28 rounded-lg object-cover border-2 border-red-200",onError:s=>{s.currentTarget.src=`${u}/uploads/members/default.jpg`}}),t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"font-medium text-gray-800 text-lg",children:((A=o[0])==null?void 0:A.full_name)||"N/A"}),t.jsxs("p",{className:"text-sm text-gray-500",children:["Time: ",(T=o[0])!=null&&T.timestamp?new Date(o[0].timestamp).toLocaleTimeString():"N/A"]}),t.jsx("span",{className:"text-sm bg-red-200 text-red-800 px-3 py-1 rounded mt-1 inline-block",children:((L=o[0])==null?void 0:L.visitor_type)||"N/A"})]})]})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow-lg overflow-hidden",children:[t.jsx("div",{className:"bg-gray-50 px-4 py-3 border-b",children:t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"All Member Sessions"})}),p.length===0?t.jsxs("div",{className:"text-center py-12",children:[t.jsx("div",{className:"text-6xl mb-4",children:"ðŸ‹ï¸"}),t.jsx("p",{className:"text-gray-600 text-lg",children:"No member activity yet."}),t.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Member statuses will appear here as they scan in/out."})]}):t.jsx("div",{className:"overflow-y-auto max-h-96",children:t.jsxs("table",{className:"w-full",children:[t.jsx("thead",{className:"bg-gray-50 sticky top-0",children:t.jsx("tr",{children:["Member","RFID","Entry","Exit","Status","Type","Balance"].map(s=>t.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:s},s))})}),t.jsx("tbody",{children:p.map((s,e)=>{const l=s.member_status||s.status||"outside",x=new Date(s.last_activity||s.entry_time||s.exit_time)>new Date(Date.now()-3e4);return t.jsxs("tr",{className:`hover:bg-gray-50 transition-colors ${x?"bg-yellow-50 border-l-4 border-yellow-400":""}`,children:[t.jsxs("td",{className:"px-4 py-3 text-sm flex items-center",children:[t.jsx("img",{src:`${u}/${s.profile_image_url||"uploads/members/default.jpg"}`,alt:s.full_name||s.rfid_tag,className:"w-10 h-10 rounded-full object-cover mr-3 border-2 border-gray-200",onError:m=>{m.currentTarget.src=`${u}/uploads/members/default.jpg`}}),t.jsx("span",{className:"font-medium",children:s.full_name||"Unknown"})]}),t.jsx("td",{className:"px-4 py-3 text-sm font-mono text-gray-600",children:s.rfid_tag}),t.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.entry_time?new Date(s.entry_time).toLocaleString():"â€”"}),t.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.exit_time?new Date(s.exit_time).toLocaleString():"â€”"}),t.jsx("td",{className:"px-4 py-3 text-sm",children:t.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-semibold ${l==="inside"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:l==="inside"?"ðŸŸ¢ Inside":"ðŸ”´ Outside"})}),t.jsxs("td",{className:"px-4 py-3 text-sm",children:[t.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs",children:s.visitor_type||"Member"}),s.system_type&&t.jsx("div",{className:"text-xs text-gray-500 mt-1",children:s.system_type.replace("_"," ")})]}),t.jsxs("td",{className:"px-4 py-3 text-sm",children:[s.system_type==="prepaid_entry"&&t.jsxs("div",{className:"text-xs",children:[s.deducted_amount&&t.jsxs("div",{className:"text-red-600 font-medium",children:["-â‚±",s.deducted_amount]}),s.remaining_balance!==void 0&&t.jsxs("div",{className:"text-gray-600",children:["â‚±",s.remaining_balance]})]}),s.system_type==="subscription"&&s.subscription_expiry&&t.jsxs("div",{className:"text-xs text-gray-600",children:["Expires: ",new Date(s.subscription_expiry).toLocaleDateString()]})]})]},`${s.id||s.rfid_tag}-${e}`)})})]})})]})]})]})};export{q as default};
