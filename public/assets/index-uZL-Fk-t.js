import{r as l,j as e,d as y,g as $,e as G}from"./index-BYZoeFiF.js";import{S as I}from"./StaffSidebar-CfYjULwa.js";import"./index-D-5OJeWc.js";const B=({rfid_tag:p,full_name:x,current_balance:f,staffUser:o})=>{const w=(o==null?void 0:o.name)||"",i=(o==null?void 0:o.adminId)||(o==null?void 0:o.admin_id)||(o==null?void 0:o.userId),[d,b]=l.useState(p||""),[t,h]=l.useState(p&&x?{rfid_tag:p,full_name:x,current_balance:parseFloat(f)}:null),[j,S]=l.useState([]),[n,k]=l.useState(null),[g,r]=l.useState(""),[c,M]=l.useState(""),[E,P]=l.useState(""),[R,N]=l.useState(""),[F,_]=l.useState([]);l.useEffect(()=>{if(!i)return;const s=async()=>{try{const{data:a}=await y.get(`/api/get-pricing/${i}`),m=a.filter(u=>u.system_type==="prepaid_entry");S(m)}catch(a){console.error("❌ Failed to fetch plans:",a)}},v=async()=>{try{const{data:a}=await y.get(`/api/payment-methods/${i}`);_(a)}catch(a){console.error("❌ Failed to fetch payment methods:",a)}};s(),v()},[i]);const D=async()=>{if(d)try{const{data:s}=await y.get(`/api/member-by-rfid/${d}`);s&&s.system_type==="prepaid_entry"?(s.admin_id=s.admin_id||i,h(s),N("")):(h(null),N("❌ Member not found or not a prepaid account."))}catch(s){console.error("Error fetching member:",s),N("❌ Error fetching member.")}},C=async()=>{if(!d||!n&&!g||!c){N("⚠️ Please complete all fields.");return}const s=(n==null?void 0:n.amount_to_pay)||parseFloat(g),v=(n==null?void 0:n.amount_to_credit)||parseFloat(g),a={rfid_tag:(t==null?void 0:t.rfid_tag)||d,full_name:(t==null?void 0:t.full_name)||x||"Unknown",admin_id:(t==null?void 0:t.admin_id)||i,staff_name:w,plan_name:(n==null?void 0:n.plan_name)||"Custom",subscription_type:(n==null?void 0:n.plan_name)||"Custom",amount_to_pay:Number(s),amount_to_credit:Number(v),payment_method:c,reference:c==="gcash"?E:null};try{const{data:m}=await y.post("/api/tapup-member",a);N("✅ Tap-up successful!"),h(null),b(""),k(null),r(""),M(""),P("")}catch(m){console.error("❌ Error submitting tap-up:",m),N("❌ Failed to tap-up member.")}};return e.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen flex gap-6",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-2xl font-bold mb-6 text-gray-900",children:"Prepaid Tap-Up"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Scan or Enter RFID"}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("input",{type:"text",value:d,onChange:s=>b(s.target.value),placeholder:"Enter RFID tag",className:"w-full p-3 border rounded-lg focus:ring-2 focus:ring-black focus:border-black outline-none"}),e.jsx("button",{onClick:D,className:"bg-black text-white px-5 py-3 rounded-lg font-semibold hover:bg-gray-800 transition",children:"Search"})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Select Top-Up Plan"}),e.jsxs("select",{value:(n==null?void 0:n.plan_name)||"",onChange:s=>{const v=j.find(a=>a.plan_name===s.target.value);k(v),r("")},className:"w-full p-3 border rounded-lg mt-2 focus:ring-2 focus:ring-black focus:border-black outline-none",children:[e.jsx("option",{value:"",children:"-- Choose a Plan (or enter custom) --"}),j.map(s=>e.jsxs("option",{value:s.plan_name,children:[s.plan_name," — ₱",s.amount_to_pay," → ₱",s.amount_to_credit]},s.id))]})]}),!n&&e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Amount"}),e.jsx("input",{type:"number",min:"1",step:"0.01",placeholder:"Enter amount",value:g,onChange:s=>r(s.target.value),className:"w-full p-3 border rounded-lg mt-2 focus:ring-2 focus:ring-black focus:border-black outline-none"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6 mb-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Payment Method"}),e.jsxs("select",{value:c,onChange:s=>M(s.target.value),className:"w-full p-3 border rounded-lg mt-2 focus:ring-2 focus:ring-black focus:border-black outline-none",children:[e.jsx("option",{value:"",children:"Select"}),F.map(s=>e.jsx("option",{value:s.name.toLowerCase(),children:s.name},s.id))]})]}),c==="gcash"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"GCash Ref No."}),e.jsx("input",{type:"text",value:E,onChange:s=>P(s.target.value),placeholder:"GCash Reference",className:"w-full p-3 border rounded-lg mt-2 focus:ring-2 focus:ring-black focus:border-black outline-none"})]})]}),e.jsx("button",{onClick:C,className:"w-full bg-black text-white py-4 rounded-xl font-semibold hover:bg-gray-800 transition",children:"Confirm Tap-Up"}),R&&e.jsx("p",{className:"mt-6 text-center text-sm text-gray-700 bg-gray-50 p-3 rounded-lg border",children:R})]}),e.jsx("div",{className:"w-80 mt-20",children:e.jsxs("div",{className:"bg-white border rounded-2xl shadow-lg overflow-hidden w-full",children:[e.jsx("div",{className:"bg-black h-20 flex items-center justify-center",children:e.jsx("h3",{className:"text-white font-bold text-lg",children:"GYM MEMBER ID"})}),e.jsxs("div",{className:"flex flex-col items-center p-6",children:[e.jsx("div",{className:"w-40 h-40 bg-gray-200 flex items-center justify-center overflow-hidden mb-4",children:t!=null&&t.profile_image_url?e.jsx("img",{src:t.profile_image_url,alt:"Member Photo"}):e.jsx("span",{className:"text-2xl text-gray-500 font-bold",children:t!=null&&t.full_name?t.full_name.charAt(0).toUpperCase():"?"})}),e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:(t==null?void 0:t.full_name)||"No Member Loaded"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:["Balance:"," ",e.jsx("span",{className:"font-medium",children:t?`₱${parseFloat(t.current_balance).toFixed(2)}`:"N/A"})]})]})]})})]})},O=({rfid_tag:p,full_name:x,subscription_expiry:f,staffUser:o})=>{const w=(o==null?void 0:o.name)||"",i=(o==null?void 0:o.adminId)||(o==null?void 0:o.admin_id)||(o==null?void 0:o.userId);$();const[d,b]=l.useState(p||""),[t,h]=l.useState(p&&x?{rfid_tag:p,full_name:x,subscription_expiry:f,subscription_type:null}:null),[j,S]=l.useState([]),[n,k]=l.useState(null),[g,r]=l.useState(""),[c,M]=l.useState(""),[E,P]=l.useState(""),[R,N]=l.useState([]),[F,_]=l.useState(""),[D,C]=l.useState(!1);l.useEffect(()=>{p&&x&&h({rfid_tag:p,full_name:x,subscription_expiry:f,subscription_type:null})},[p,x,f]),l.useEffect(()=>{if(!i)return;const a=async()=>{try{const{data:u}=await y.get(`/api/get-pricing/${i}`),T=u.filter(A=>A.system_type==="subscription");S(T)}catch(u){console.error("❌ Failed to fetch plans:",u)}},m=async()=>{try{const{data:u}=await y.get(`/api/payment-methods/${i}`);N(u)}catch(u){console.error("❌ Failed to fetch payment methods:",u)}};a(),m()},[i]),l.useEffect(()=>{d&&d.length>=8&&s()},[d]);const s=async()=>{if(d){C(!0);try{const{data:a}=await y.get(`/api/member-by-rfid/${d}`);a&&a.system_type==="subscription"?(a.admin_id=a.admin_id||i,h(a),_("")):(h(null),_("❌ Member not found or not a subscription account."))}catch(a){console.error("❌ Error fetching member:",a),_("❌ Error fetching member data."),h(null)}finally{C(!1)}}},v=async()=>{if(!t||!n||!c||!w||!g){_("⚠️ Please complete all required fields.");return}C(!0);try{const a=new Date(t.subscription_expiry),m=isNaN(a.getTime())?new Date:a,u=m.toISOString().split("T")[0],T=new Date(m);T.setDate(T.getDate()+n.duration_in_days);const A=T.toISOString().split("T")[0],L={rfid_tag:t.rfid_tag,full_name:t.full_name,admin_id:t.admin_id||i,staff_name:w,plan_name:n.plan_name,payment:Number(g),subscription_type:n.plan_name,subscription_start:u,subscription_expiry:A,payment_Method:c.toLowerCase().includes("gcash")?"gcash":c,reference:c.toLowerCase().includes("gcash")?E||"":null};console.log("📤 Payload to submit:",L);const{data:q}=await y.post("/api/renew-subscription",L);_("✅ Subscription renewed successfully!"),h(null),b(""),k(null),r(""),M(""),P("")}catch(a){console.error("❌ Error submitting renewal:",a),_("❌ Failed to renew subscription.")}finally{C(!1)}};return e.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen flex gap-6",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-2xl font-bold mb-6 text-gray-900",children:"Subscription Renewal"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Scan or Enter RFID"}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("input",{type:"text",value:d,onChange:a=>b(a.target.value),placeholder:"Enter RFID tag",className:"w-full p-3 border rounded-lg focus:ring-2 focus:ring-black focus:border-black outline-none"}),e.jsx("button",{onClick:s,className:"bg-black text-white px-5 py-3 rounded-lg font-semibold hover:bg-gray-800 transition",children:"Search"})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Select Renewal Plan"}),e.jsxs("select",{value:(n==null?void 0:n.plan_name)||"",onChange:a=>{const m=j.find(u=>u.plan_name===a.target.value);k(m),r(m?m.amount_to_pay:"")},className:"w-full p-3 border rounded-lg mt-2 focus:ring-2 focus:ring-black focus:border-black outline-none",children:[e.jsx("option",{value:"",children:"-- Choose a Plan --"}),j.map(a=>e.jsxs("option",{value:a.plan_name,children:[a.plan_name," — ₱",a.amount_to_pay," for"," ",a.duration_in_days," day",a.duration_in_days>1?"s":""]},a.id))]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Amount to Pay"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:g,onChange:a=>r(a.target.value),placeholder:"Enter amount to pay",className:"w-full p-3 border rounded-lg mt-2 focus:ring-2 focus:ring-black focus:border-black outline-none"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6 mb-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Payment Method"}),e.jsxs("select",{value:c,onChange:a=>M(a.target.value),className:"w-full p-3 border rounded-lg mt-2 focus:ring-2 focus:ring-black focus:border-black outline-none",children:[e.jsx("option",{value:"",children:"Select"}),R.map(a=>e.jsx("option",{value:a.name.toLowerCase(),children:a.name},a.id))]})]}),c!=="cash"&&c!==""&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium",children:[c.charAt(0).toUpperCase()+c.slice(1)," Reference No."]}),e.jsx("input",{type:"text",value:E,onChange:a=>P(a.target.value),className:"w-full p-3 border rounded-lg mt-2 focus:ring-2 focus:ring-black focus:border-black outline-none",required:!0})]})]}),e.jsx("button",{onClick:v,className:"w-full bg-black text-white py-4 rounded-xl font-semibold hover:bg-gray-800 transition",children:"Confirm Renewal"}),F&&e.jsx("p",{className:"mt-6 text-center text-sm text-gray-700 bg-gray-50 p-3 rounded-lg border",children:F})]}),e.jsx("div",{className:"w-80 mt-20",children:e.jsxs("div",{className:"bg-white border rounded-2xl shadow-lg overflow-hidden",children:[e.jsx("div",{className:"bg-black h-20 flex items-center justify-center",children:e.jsx("h3",{className:"text-white font-bold text-lg",children:"GYM MEMBER ID"})}),e.jsxs("div",{className:"flex flex-col items-center p-6",children:[e.jsx("div",{className:"w-40 h-40 bg-gray-200 flex items-center justify-center overflow-hidden mb-4",children:t!=null&&t.profile_image_url?e.jsx("img",{src:t.profile_image_url,alt:"Member Photo"}):e.jsx("span",{className:"text-2xl text-gray-500 font-bold",children:t!=null&&t.full_name?t.full_name.charAt(0).toUpperCase():"?"})}),e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:(t==null?void 0:t.full_name)||"No Member Loaded"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:["Plan:"," ",e.jsx("span",{className:"font-medium",children:(t==null?void 0:t.subscription_type)||"N/A"})]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Expires:"," ",e.jsx("span",{className:"font-medium",children:(t==null?void 0:t.subscription_expiry)||"N/A"})]})]})]})})]})},J=()=>{const p=G(),{rfid_tag:x,full_name:f,current_balance:o,subscription_expiry:w}=p.state||{},[i,d]=l.useState(null),[b,t]=l.useState(""),[h,j]=l.useState(!0),[S,n]=l.useState(null);return l.useEffect(()=>{(async()=>{var g;try{j(!0),n(null);const{data:r}=await y.get("/api/me");if(console.log("📥 Staff info response:",r),!r.authenticated||!r.user)throw new Error("Not authenticated");if(r.user.role!=="staff"&&r.user.role!=="admin")throw new Error("Only staff/admin can access Membership Transactions");d(r.user);const c=(r.user.systemType||r.user.system_type||"").toLowerCase().trim();t(c)}catch(r){console.error("❌ Failed to fetch staff info:",r),n(r.message||"Failed to fetch staff info"),((g=r.response)==null?void 0:g.status)===401&&(window.location.href="/login")}finally{j(!1)}})()},[]),h?e.jsxs("div",{className:"flex",children:[e.jsx(I,{}),e.jsxs("div",{className:"flex-1 p-6 text-center py-12",children:[e.jsx("div",{className:"text-4xl mb-4",children:"⏳"}),e.jsx("p",{className:"text-gray-600",children:"Loading transaction system..."})]})]}):S?e.jsxs("div",{className:"flex",children:[e.jsx(I,{}),e.jsxs("div",{className:"flex-1 p-6 text-center py-12",children:[e.jsx("div",{className:"text-6xl mb-4",children:"❌"}),e.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-2",children:"Error Loading Transaction System"}),e.jsx("p",{className:"text-gray-600 mb-4",children:S}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Try Again"})]})]}):b?e.jsxs("div",{className:"flex",children:[e.jsx(I,{}),e.jsx("div",{className:"flex-1 p-4",children:b==="prepaid_entry"?e.jsx(B,{rfid_tag:x,full_name:f,current_balance:o,staffUser:i}):b==="subscription"?e.jsx(O,{rfid_tag:x,full_name:f,subscription_expiry:w,staffUser:i}):e.jsxs("div",{className:"text-gray-600",children:['Unknown system type: "',b,'". Please contact admin.']})})]}):e.jsxs("div",{className:"flex",children:[e.jsx(I,{}),e.jsx("div",{className:"flex-1 p-6 text-center py-12 text-gray-600",children:"Unknown system type. Please contact admin."})]})};export{J as default};
