import{r as t,g as T,e as O,j as e,d as C}from"./index-BYZoeFiF.js";import{S as D}from"./StaffSidebar-CfYjULwa.js";import"./index-D-5OJeWc.js";const z=({rfid_tag:f,staffUser:u})=>{const P=u==null?void 0:u.name,d=u==null?void 0:u.adminId,[a,p]=t.useState({full_name:"",gender:"",age:"",rfid_tag:f||"",phone_number:"",address:"",email:"",password:"",membership_type:"",payment:"",initial_balance:"",payment_method:"cash",reference:""}),[j,v]=t.useState(null),[N,_]=t.useState(null),[w,A]=t.useState(""),[S,x]=t.useState([]),[k,M]=t.useState([]);t.useRef(null),T();const F=O();t.useEffect(()=>{f&&p(r=>({...r,rfid_tag:f}))},[f]),t.useEffect(()=>{if(!d)return;(async()=>{try{const{data:s}=await C.get(`/api/payment-methods/${d}`);M(s)}catch(s){console.error("❌ Failed to fetch payment methods:",s)}})()},[d]),t.useEffect(()=>{var s;const r=(s=F.state)==null?void 0:s.rfid_tag;r&&r!==a.rfid_tag&&p(i=>({...i,rfid_tag:r}))},[F.state,a.rfid_tag]),t.useEffect(()=>{if(!d)return;(async()=>{try{const{data:s}=await C.get(`/api/get-pricing/${d}`);x(s.filter(i=>i.system_type==="prepaid_entry"))}catch(s){console.error("❌ Failed to fetch plans:",s)}})()},[d]);const E=r=>{const s=r.target.files[0];if(s){const i=new FileReader;i.onload=()=>_(i.result),i.readAsDataURL(s),v(s)}},h=r=>{const{name:s,value:i}=r.target;if(s==="plan_name"){const g=S.find(c=>c.plan_name===i);p(g?c=>({...c,plan_name:i,payment:g.amount_to_pay,initial_balance:g.amount_to_credit}):c=>({...c,plan_name:i,payment:"",initial_balance:""}));return}if(s==="payment"){const g=parseFloat(i),c=isNaN(g)?"":g.toFixed(2);p(b=>({...b,payment:i,initial_balance:c}));return}p(g=>({...g,[s]:i}))},q=async r=>{var i,g;if(r.preventDefault(),!P||!d){alert("⚠️ Staff info missing. Please login again.");return}const s=new FormData;Object.entries({...a,staff_name:P,admin_id:d}).forEach(([c,b])=>{b!=null&&s.append(c,b)}),j&&s.append("member_image",j),console.log("📤 Sending FormData:");for(let[c,b]of s.entries())console.log(`${c}:`,b);try{const b=(await C.post("/api/add-member",s,{headers:{"Content-Type":"multipart/form-data"}})).data;A(b.message),alert("✅ Member added successfully!"),p({full_name:"",gender:"",age:"",rfid_tag:"",phone_number:"",address:"",email:"",password:"",payment:"",payment_method:"cash",initial_balance:"",reference:""}),v(null),_(null)}catch(c){console.error("❌ Error submitting form:",c);const b=((g=(i=c.response)==null?void 0:i.data)==null?void 0:g.message)||"Something went wrong. Please try again.";alert(`❌ ${b}`)}};return e.jsx("div",{className:"px-6 py-8 bg-gray-100 min-h-screen",children:e.jsxs("main",{className:"max-w-screen-lg",children:[e.jsx("h1",{className:"text-xl font-bold mb-6 text-black",children:"➕ Add Prepaid Member"}),e.jsxs("form",{onSubmit:q,className:"grid grid-cols-1 md:grid-cols-3 gap-6 p-6 bg-white rounded-lg shadow",children:[e.jsxs("div",{className:"md:col-span-2 flex flex-col gap-6",children:[e.jsxs("section",{className:"flex flex-col gap-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-black",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-black",children:"Full Name"}),e.jsx("input",{type:"text",name:"full_name",value:a.full_name,onChange:h,required:!0,className:"w-full border border-gray-300 px-3 py-2 rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-black",children:"RFID Tag"}),e.jsx("input",{type:"text",name:"rfid_tag",value:a.rfid_tag,readOnly:!0,className:"w-full border border-gray-300 px-3 py-2 rounded bg-gray-100 text-black cursor-not-allowed"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block mb-1 text-black",children:"Email"}),e.jsx("input",{type:"email",name:"email",value:a.email,onChange:h,required:!0,className:"w-full border border-gray-300 px-3 py-2 rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-black",children:"Password"}),e.jsx("input",{type:"password",name:"password",value:a.password,onChange:h,required:!0,autoComplete:"current-password",className:"w-full border border-gray-300 px-3 py-2 rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-black",children:"Phone Number"}),e.jsx("input",{type:"text",name:"phone_number",value:a.phone_number,onChange:h,required:!0,className:"w-full border border-gray-300 px-3 py-2 rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-black",children:"Age"}),e.jsx("input",{type:"number",name:"age",value:a.age,onChange:h,required:!0,className:"w-full border border-gray-300 px-3 py-2 rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-black",children:"Gender"}),e.jsxs("select",{name:"gender",value:a.gender,onChange:h,required:!0,className:"w-full border border-gray-300 px-3 py-2 rounded bg-white",children:[e.jsx("option",{value:"",children:"Select gender"}),e.jsx("option",{value:"Male",children:"Male"}),e.jsx("option",{value:"Female",children:"Female"}),e.jsx("option",{value:"Other",children:"Other"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-black",children:"Address"}),e.jsx("textarea",{name:"address",value:a.address,onChange:h,required:!0,className:"w-full border border-gray-300 px-3 py-2 rounded"})]})]}),e.jsxs("section",{className:"flex flex-col gap-2",children:[e.jsx("h2",{className:"text-lg font-semibold text-black",children:"Plan Details"}),e.jsxs("select",{name:"plan_name",value:a.plan_name,onChange:h,required:!0,className:"w-full border border-gray-300 px-3 py-2 rounded bg-white",children:[e.jsx("option",{value:"",children:"-- Choose a Plan --"}),S.map(r=>e.jsxs("option",{value:r.plan_name,children:[r.plan_name," — ₱",r.amount_to_pay," → ₱",r.amount_to_credit]},r.id))]})]}),e.jsxs("section",{className:"flex flex-col gap-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-black",children:"Payment Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-black",children:"Payment (₱)"}),e.jsx("input",{type:"text",name:"payment",value:a.payment,onChange:h,className:"w-full border border-gray-300 px-3 py-2 rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-black",children:"Balance to be Added"}),e.jsx("input",{type:"text",name:"initial_balance",value:a.initial_balance,readOnly:!0,className:"w-full border border-gray-200 bg-gray-50 px-3 py-2 rounded text-black"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-black",children:"Payment Method"}),e.jsxs("select",{name:"payment_method",value:a.payment_method,onChange:h,required:!0,className:"w-full border border-gray-300 px-3 py-2 rounded bg-white",children:[e.jsx("option",{value:"",children:"Select Payment Method"}),k.map(r=>e.jsx("option",{value:r.name.toLowerCase(),children:r.name},r.id))]})]}),a.payment_method&&a.payment_method!=="cash"&&e.jsxs("div",{children:[e.jsxs("label",{className:"block mb-1 text-black",children:[a.payment_method.toUpperCase()," Reference No."]}),e.jsx("input",{type:"text",name:"reference",value:a.reference,onChange:h,required:!0,className:"w-full border border-gray-300 px-3 py-2 rounded"})]})]})]}),e.jsxs("div",{children:[e.jsx("button",{type:"submit",className:"w-1/2 mt-2 px-5 py-2 rounded bg-black text-white font-semibold",children:"➕ Add Member"}),w&&e.jsx("p",{className:"text-sm text-gray-600 mt-2",children:w})]})]}),e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-black",children:"Profile Picture"}),e.jsx("div",{className:"w-40 h-40 border border-gray-300 rounded flex items-center justify-center bg-gray-50 overflow-hidden",children:N?e.jsx("img",{src:N,alt:"Profile Preview",className:"w-full h-full object-cover"}):e.jsx("span",{className:"text-gray-400 text-sm",children:"Upload Photo"})}),e.jsx("input",{type:"file",accept:"image/*",onChange:E,className:"w-full px-3 py-2 border border-gray-300 rounded"})]})]})]})})},H=({rfid_tag:f,staffUser:u})=>{const P=u==null?void 0:u.name,d=u==null?void 0:u.adminId,[a,p]=t.useState({full_name:"",age:"",gender:"",rfid_tag:f||"",phone_number:"",address:"",email:"",password:"",payment_method:"",reference:"",gcash_reference:"",plan_name:""}),[j,v]=t.useState(null),[N,_]=t.useState(null),[w,A]=t.useState(""),[S,x]=t.useState([]),[k,M]=t.useState(0),[F,E]=t.useState(""),[h,q]=t.useState(""),[r,s]=t.useState(""),[i,g]=t.useState([]);t.useRef(null),T();const c=O();t.useEffect(()=>{f&&p(l=>({...l,rfid_tag:f}))},[f]),t.useEffect(()=>{var n;const l=(n=c.state)==null?void 0:n.rfid_tag;l&&l!==a.rfid_tag&&p(o=>({...o,rfid_tag:l}))},[c.state,a.rfid_tag]),t.useEffect(()=>{if(!d)return;(async()=>{try{const{data:n}=await C.get(`/api/payment-methods/${d}`);g(n)}catch(n){console.error("❌ Failed to fetch payment methods:",n)}})()},[d]),t.useEffect(()=>{if(!d)return;(async()=>{try{const{data:n}=await C.get(`/api/get-pricing/${d}`);x(n.filter(o=>o.system_type==="subscription"))}catch(n){console.error("❌ Failed to fetch plans:",n)}})()},[d]);const b=l=>{const n=l.target.files[0];if(n){const o=new FileReader;o.onload=()=>_(o.result),o.readAsDataURL(n),v(n)}},y=l=>{const{name:n,value:o}=l.target;p(m=>({...m,[n]:o}))},R=l=>{const n=l.target.value,o=S.find(m=>m.plan_name===n);if(o){const m=new Date,L=m.toISOString().split("T")[0],I=new Date(m);I.setDate(I.getDate()+o.duration_in_days);const B=I.toISOString().split("T")[0];E(o.plan_name),M(o.amount_to_pay),q(L),s(B),p(G=>({...G,plan_name:o.plan_name}))}else E(""),M(0),q(""),s(""),p(m=>({...m,plan_name:""}))},$=async l=>{if(l.preventDefault(),!P||!d){alert("⚠️ Staff info missing. Please login again.");return}const n=new FormData;Object.entries({...a,staff_name:P,admin_id:d}).forEach(([o,m])=>{m!=null&&n.append(o,m)}),n.append("subscription_type",F),n.append("subscription_start",h),n.append("subscription_expiry",r),n.append("payment",k),j&&n.append("member_image",j),console.log("📤 Sending FormData:");for(let[o,m]of n.entries())console.log(`${o}:`,m);try{const o=await C.post("/api/add-member",n,{headers:{"Content-Type":"multipart/form-data"}}),m=await o.json();A(m.message),o.ok?(alert("✅ Member added successfully!"),p({full_name:"",age:"",gender:"",rfid_tag:"",phone_number:"",address:"",email:"",password:"",payment_method:"",reference:"",gcash_reference:"",plan_name:""}),v(null),_(null),E(""),M(0),q(""),s("")):alert(`❌ Error: ${m.message}`)}catch(o){console.error("❌ Error submitting form:",o),alert("Something went wrong. Please try again.")}};return e.jsx("div",{className:"flex bg-gray-50 min-h-screen",children:e.jsxs("main",{className:"flex-1 p-6",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6 text-gray-900",children:"➕ Add Subscription Member"}),e.jsxs("form",{onSubmit:$,className:"grid grid-cols-1 md:grid-cols-3 gap-8 bg-white p-8 rounded-2xl shadow-lg",children:["          ",e.jsxs("div",{className:"md:col-span-2 space-y-6",children:[e.jsxs("section",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-3",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx("input",{type:"text",name:"full_name",value:a.full_name,onChange:y,placeholder:"Full Name",className:"w-full p-3 border rounded-lg",required:!0}),e.jsx("input",{type:"text",name:"rfid_tag",value:a.rfid_tag,readOnly:!0,className:"w-full p-3 border rounded-lg bg-gray-100 text-gray-500"}),e.jsx("input",{type:"email",name:"email",value:a.email,onChange:y,placeholder:"Email",className:"w-full p-3 border rounded-lg col-span-2",required:!0}),e.jsx("input",{type:"password",name:"password",value:a.password,onChange:y,placeholder:"Password",className:"w-full p-3 border rounded-lg",required:!0,autocomplete:"current-password"}),e.jsx("input",{type:"text",name:"phone_number",value:a.phone_number,onChange:y,placeholder:"Phone Number",className:"w-full p-3 border rounded-lg",required:!0}),e.jsx("input",{type:"number",name:"age",value:a.age,onChange:y,placeholder:"Age",className:"w-full p-3 border rounded-lg",required:!0}),e.jsxs("select",{name:"gender",value:a.gender,onChange:y,className:"w-full p-3 border rounded-lg",required:!0,children:[e.jsx("option",{value:"",children:"Gender"}),e.jsx("option",{value:"Male",children:"Male"}),e.jsx("option",{value:"Female",children:"Female"}),e.jsx("option",{value:"Other",children:"Other"})]})]}),e.jsx("textarea",{name:"address",value:a.address,onChange:y,placeholder:"Address",className:"w-full p-3 border rounded-lg mt-4",required:!0})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-3",children:"Subscription Details"}),e.jsxs("select",{value:F,onChange:R,className:"w-full p-3 border rounded-lg",required:!0,children:[e.jsx("option",{value:"",children:"-- Choose a Plan --"}),S.map(l=>e.jsxs("option",{value:l.plan_name,children:[l.plan_name," — ₱",l.amount_to_pay," /"," ",l.duration_in_days," days"]},l.id))]}),e.jsx("div",{className:"mt-3",children:e.jsx("input",{type:"text",value:`₱${k}`,readOnly:!0,className:"w-full p-3 border rounded-lg bg-gray-100"})})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-3",children:"Payment Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("select",{name:"payment_method",value:a.payment_method,onChange:y,className:"w-full p-3 border rounded-lg",required:!0,children:[e.jsx("option",{value:"",children:"Select Payment Method"}),i.map(l=>e.jsx("option",{value:l.name.toLowerCase(),children:l.name},l.id))]}),a.payment_method&&a.payment_method!=="cash"&&e.jsx("input",{type:"text",name:"reference",value:a.reference,onChange:y,placeholder:`${a.payment_method.toUpperCase()} Reference No.`,className:"w-full p-3 border rounded-lg",required:!0})]})]}),e.jsx("button",{type:"submit",className:"w-full bg-black text-white py-4 rounded-xl font-semibold hover:bg-gray-800 transition",children:"➕ Add Member"}),w&&e.jsx("p",{className:"text-sm text-center text-gray-600 mt-4",children:w})]}),e.jsxs("div",{className:"flex flex-col items-center justify-start space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Profile Picture"}),e.jsx("div",{className:"w-48 h-48 border-2 border-gray-300 rounded-lg flex items-center justify-center bg-gray-100 overflow-hidden",children:N?e.jsx("img",{src:N,alt:"Profile Preview",className:"w-full h-full object-cover"}):e.jsx("span",{className:"text-gray-500 text-sm",children:"Choose File"})}),e.jsx("input",{type:"file",name:"profile_image_url",accept:"image/*",onChange:b,className:"w-full p-2 border rounded"})]})]})]})})},V=()=>{var w;const f=O(),[u,P]=t.useState(null),[d,a]=t.useState(""),[p,j]=t.useState(!0),[v,N]=t.useState(null),_=((w=f.state)==null?void 0:w.rfid_tag)||"";return t.useEffect(()=>{(async()=>{var S;try{j(!0),N(null);const{data:x}=await C.get("/api/me");if(console.log("📥 Staff info response:",x),!x.authenticated||!x.user)throw new Error("Not authenticated");if(x.user.role!=="staff"&&x.user.role!=="admin")throw new Error("Only staff/admin can access AddMember");P(x.user);const k=x.user.systemType||x.user.system_type||"";a(k),console.log("🔍 System type:",k)}catch(x){console.error("❌ Failed to fetch staff info:",x),N(x.message||"Failed to fetch staff info"),((S=x.response)==null?void 0:S.status)===401&&(window.location.href="/login")}finally{j(!1)}})()},[]),p?e.jsxs("div",{className:"flex",children:[e.jsx(D,{}),e.jsxs("div",{className:"flex-1 p-6 text-center py-12",children:[e.jsx("div",{className:"text-4xl mb-4",children:"⏳"}),e.jsx("p",{className:"text-gray-600",children:"Loading Add Member system..."})]})]}):v?e.jsxs("div",{className:"flex",children:[e.jsx(D,{}),e.jsxs("div",{className:"flex-1 p-6 text-center py-12",children:[e.jsx("div",{className:"text-6xl mb-4",children:"❌"}),e.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-2",children:"Error"}),e.jsx("p",{className:"text-gray-600 mb-4",children:v}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Try Again"})]})]}):d?e.jsxs("div",{className:"flex",children:[e.jsx(D,{}),e.jsx("div",{className:"flex-1 p-4",children:d==="prepaid_entry"?e.jsx(z,{rfid_tag:_,staffUser:u}):d==="subscription"?e.jsx(H,{rfid_tag:_,staffUser:u}):e.jsxs("div",{className:"text-gray-600",children:['Unknown system type: "',d,'". Please contact admin.']})})]}):e.jsxs("div",{className:"flex",children:[e.jsx(D,{}),e.jsx("div",{className:"flex-1 p-6 text-center py-12 text-gray-600",children:"Unknown system type. Please contact admin."})]})};export{V as default};
